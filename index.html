<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>학생 답안 제출 시스템</title>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js'></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 2em; background-color: #f4f4f9; color: #333; }
        .container { max-width: 80%; margin: auto; background-color: #fff; padding: 2em; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #0056b3; }
        .form-group { margin-bottom: 1.2em; }
        label { display: block; margin-bottom: 0.5em; font-weight: bold; }
        input, select { width: 100%; padding: 0.8em; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 0.8em 1.5em; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; font-size: 1em; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        .delete-btn, .reprocess-btn, .edit-btn, .delete-record-btn { font-size: 0.8em; padding: 0.4em 0.8em; margin-left: 5px; }
        .delete-btn, .delete-record-btn { background-color: #dc3545; }
        .reprocess-btn { background-color: #ffc107; color: black; }
        .edit-btn { background-color: #17a2b8; }
        hr { border: 0; height: 1px; background-color: #eee; margin: 2em 0; }
        #message { margin-top: 1em; padding: 1em; border-radius: 5px; display: none; text-align: center; font-weight: bold; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        #admin-panel { display: none; border: 2px dashed #007bff; padding: 1.5em; border-radius: 8px; margin-top: 2em; }
        .form-list-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5em; border-bottom: 1px solid #eee; }
        .admin-controls { text-align: right; margin-bottom: 1em; }
        .input-group { display: flex; gap: 10px; }
        #assistant-panel { display: block; }
        #main-content { display: none; }
        #answers-container .answer-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .answer-row input.question_number { flex: 0 0 70px; background-color: #e9ecef; text-align: center; }
        .answer-row select.is_correct { flex: 0 0 120px; }
        .answer-row input.failed_edge_id { flex: 1 1 auto; }
        #calendar { max-width: 1100px; margin: 2em auto; }
        .fc-event { cursor: pointer; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 900px; border-radius: 8px; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        #student-details-container { margin-top: 20px; max-height: 400px; overflow-y: auto; }
        #student-details-container table { width: 100%; border-collapse: collapse; }
        #student-details-container th, #student-details-container td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    </style>
</head>
<body>
    <div class="container">
        <div class="admin-controls"><button id="toggle-admin-mode">관리자 모드</button></div>
        <div id="assistant-panel">
            <h1>학생 답안 제출</h1>
            <div class="form-group"><label for="form-select">수업 선택:</label><select id="form-select"><option value="">-- 먼저 수업을 선택하세요 --</option></select></div><hr>
            <div id="main-content">
                <form id="submission-form">
                    <div class="form-group"><label for="student_name">학생 이름:</label><input type="text" id="student_name" required></div>
                    <div class="form-group"><label for="phone_suffix">전화번호 뒤 4자리:</label><input type="text" id="phone_suffix" pattern="\d{4}" required></div>
                    <div class="form-group"><label for="subject">과목:</label><input type="text" id="subject" required readonly style="background-color: #e9ecef;"></div>
                    <h2>답안 입력</h2><div id="answers-container"></div><hr><button type="submit">제출하기</button>
                </form>
            </div>
        </div>
        <div id="admin-panel">
            <h2>관리자 모드: 수업 관리</h2>
            <div id="form-list"><h3>현재 수업 목록</h3><div id="current-forms-container"></div></div><hr><h3>새 수업 추가</h3>
            <div class="form-group"><label for="new-form-name">수업 이름:</label><input type="text" id="new-form-name"></div>
            <div class="form-group"><label for="new-form-subject">과목명:</label><input type="text" id="new-form-subject"></div>
            <div class="form-group"><label>문제 번호 범위:</label><div class="input-group"><input type="number" id="new-form-start" min="1" placeholder="시작"><input type="number" id="new-form-end" min="1" placeholder="끝"></div></div>
            <button id="add-form-btn">새 수업 저장하기</button><hr>
            <h2>제출 데이터 조회</h2>
            <div id='calendar'></div><hr>
            <h2>학생 데이터 전체 재계산 (주의!)</h2>
            <div class="form-group"><label for="student-select">재계산할 학생 선택:</label><select id="student-select"><option value="">-- 학생을 선택하세요 --</option></select></div>
            <button id="full-recalc-btn" class="delete-btn">선택한 학생 전체 재계산 요청</button>
        </div>
        <div id="message"></div>
    </div>
    <div id="detailsModal" class="modal"><div class="modal-content"><span class="close">&times;</span><h2 id="modalDateTitle"></h2><div id="student-details-container"></div></div></div>

    <script>
        const assistantPanel=document.getElementById('assistant-panel'), adminPanel=document.getElementById('admin-panel'), toggleAdminBtn=document.getElementById('toggle-admin-mode'), formSelect=document.getElementById('form-select'), currentFormsContainer=document.getElementById('current-forms-container'), modal=document.getElementById('detailsModal'), modalDateTitle=document.getElementById('modalDateTitle'), studentDetailsContainer=document.getElementById('student-details-container'), closeModal=document.getElementsByClassName("close")[0], studentSelect=document.getElementById('student-select');
        let forms=[], calendar;
        const ADMIN_PASSWORD = "dusrntlf";
        
        function formatKST(isoString) { if (!isoString) return ''; return new Date(isoString).toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' }); }

        document.addEventListener('DOMContentLoaded', function() {
            calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
                initialView: 'dayGridMonth', locale: 'ko',
                headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth' },
                events: (fetchInfo, successCallback, failureCallback) => {
                    // 이제 모든 API 요청은 세션 쿠키를 통해 인증되므로, API 키를 보낼 필요가 없습니다.
                    fetch(`/api/calendar/events?start=${fetchInfo.startStr}&end=${fetchInfo.endStr}`)
                        .then(res => {
                            if (res.status === 401) { // 인증 실패 시, 이벤트 로드를 조용히 중단
                                successCallback([]); // 빈 배열을 반환하여 에러 메시지 방지
                                return null;
                            }
                            return res.json();
                        })
                        .then(events => {
                            if(events) successCallback(events);
                        })
                        .catch(err => { 
                            console.error('달력 데이터 로딩 실패:', err); 
                            failureCallback(err);
                        });
                },
                eventClick: function(info) {
                    info.jsEvent.preventDefault();
                    const formId = info.event.extendedProps.formId, dateStr = info.event.startStr, formName = info.event.title;
                    modalDateTitle.textContent = `${dateStr} - ${formName} 제출 목록`;
                    studentDetailsContainer.innerHTML = '<h4>로딩 중...</h4>'; modal.style.display = "block";
                    fetch(`/api/data/by-date-form/${dateStr}/${formId}`).then(res => res.json()).then(details => renderStudentDetails(details)).catch(e => { console.error(e); studentDetailsContainer.innerHTML = `<p style="color: red;">${e.message}</p>`; });
                }
            });
            checkAuthStatus();
        });
        
        async function checkAuthStatus() { try { const response = await fetch('/api/auth-status'); const data = await response.json(); if (data.is_admin) { enterAdminMode(false); } } catch (error) { console.error("인증 상태 확인 실패:", error); } }
        function renderStudentDetails(details) { studentDetailsContainer.innerHTML = ''; if (!details || details.length === 0) { studentDetailsContainer.textContent = '해당하는 데이터가 없습니다.'; return; } const table = document.createElement('table'); table.innerHTML = `<thead><tr><th>ID</th><th>학생 식별</th><th>상태</th><th>최종 제출 시각</th><th style="width: 210px;">작업</th></tr></thead><tbody></tbody>`; const tbody = table.querySelector('tbody'); details.forEach(item => { const row = tbody.insertRow(), studentIdentifier = `${item.student_name}(${item.phone_suffix})`; const statusText = item.status === 'processed' ? `완료(${formatKST(item.processed_at)})` : '대기'; row.innerHTML = `<td>${item.id}</td><td>${studentIdentifier}</td><td>${statusText}</td><td>${formatKST(item.submitted_at)}</td><td><button class="reprocess-btn" data-id="${item.id}" ${item.status === 'pending' ? 'disabled' : ''}>재처리</button><button class="edit-btn" data-id="${item.id}">수정</button><button class="delete-record-btn" data-id="${item.id}">삭제</button></td>`; }); studentDetailsContainer.appendChild(table); }
        function populateFormForEdit(data) { formSelect.value = data.form_id; formSelect.dispatchEvent(new Event('change')); document.getElementById('student_name').value = data.student_name; document.getElementById('phone_suffix').value = data.phone_suffix; setTimeout(() => { document.querySelectorAll('#answers-container .answer-row').forEach(row => { const qNum = row.querySelector('.question_number').value; const answerData = data.answers.find(ans => ans['Question Number'] === qNum); if (answerData) { row.querySelector('.is_correct').value = answerData.is_correct ? 'true' : 'false'; row.querySelector('.failed_edge_id').value = answerData.failed_edge_id || ''; } }); }, 100); modal.style.display = 'none'; if (adminPanel.style.display === 'block') { toggleAdminBtn.click(); } }
        async function loadFormsFromServer() { try { const res = await fetch('/api/forms'); if (!res.ok) throw new Error('수업 목록 로딩 실패'); forms = await res.json(); renderAll(); } catch (error) { console.error(error); alert(error.message); } }
        async function loadAllStudents() { try { const response = await fetch('/api/students'); const students = await response.json(); studentSelect.innerHTML = '<option value="">-- 학생 선택 --</option>'; students.forEach(sId => { const o = document.createElement('option'); o.value = sId; o.textContent = sId; studentSelect.appendChild(o); }); } catch (error) { console.error('학생 목록 로딩 실패:', error); } }
        function renderAssistantView() { formSelect.innerHTML = '<option value="">-- 수업 선택 --</option>'; forms.forEach(f => { const o = document.createElement('option'); o.value = f.id; o.textContent = f.name; formSelect.appendChild(o); }); }
        function renderAdminView() { currentFormsContainer.innerHTML = ''; if (forms.length === 0) { currentFormsContainer.textContent = "저장된 수업이 없습니다."; } else { forms.forEach(f => { const i = document.createElement('div'); i.className = 'form-list-item'; i.innerHTML = `<span><strong>${f.name}</strong> (${f.subject}, ${f.startNumber}~${f.endNumber}번)</span><button class="delete-btn" data-id="${f.id}">삭제</button>`; currentFormsContainer.appendChild(i); }); } }
        function renderAll() { renderAssistantView(); renderAdminView(); }

        function enterAdminMode(showPrompt = true) {
            function proceed() {
                loadAllStudents();
                adminPanel.style.display = 'block';
                assistantPanel.style.display = 'none';
                toggleAdminBtn.textContent = '로그아웃';
                if (calendar) {
                    calendar.render();
                    calendar.refetchEvents(); // [핵심] 로그인 성공 후, 달력 이벤트를 다시 불러옵니다.
                }
            }
            if (showPrompt) {
                const password = prompt("관리자 비밀번호를 입력하세요:");
                if (password) {
                    fetch('/api/login', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ password: password }) })
                    .then(res => { if (res.ok) { proceed(); } else { alert("비밀번호가 틀렸습니다."); } });
                }
            } else { proceed(); }
        }
        async function logout() {
            await fetch('/api/logout', { method: 'POST' });
            adminPanel.style.display = 'none';
            assistantPanel.style.display = 'block';
            toggleAdminBtn.textContent = '관리자 모드';
            if (calendar) {
                calendar.refetchEvents(); // [핵심] 로그아웃 후, 달력 이벤트를 다시 불러와서 비웁니다.
            }
        }
        toggleAdminBtn.addEventListener('click', () => { if (adminPanel.style.display === 'block') { logout(); } else { enterAdminMode(true); } });
        
        async function handleAdminAction(url, method, body) {
            try { const opts = { method, headers: {} }; if (body) { opts.headers['Content-Type'] = 'application/json'; opts.body = JSON.stringify(body); } const res = await fetch(url, opts); if (res.status === 401) { alert('인증이 필요하거나 세션이 만료되었습니다. 다시 로그인해주세요.'); logout(); return false; } const result = await res.json(); if (!res.ok) throw new Error(result.error || '작업 실패'); alert(result.message); return true; } catch (error) { console.error(error); alert(error.message); return false; }
        }
        
        document.getElementById('add-form-btn').addEventListener('click', async () => { const n=document.getElementById('new-form-name').value.trim(), s=document.getElementById('new-form-subject').value.trim(), st=parseInt(document.getElementById('new-form-start').value, 10), e=parseInt(document.getElementById('new-form-end').value, 10); if (!n || !s || !st || !e || st < 1 || e < st) { alert('모든 항목을 올바르게 입력해주세요.'); return; } const nf = { id: `form_${Date.now()}`, name: n, subject: s, startNumber: st, endNumber: e }; if (await handleAdminAction('/api/forms', 'POST', nf)) { document.getElementById('new-form-name').value = ''; document.getElementById('new-form-subject').value = ''; document.getElementById('new-form-start').value = ''; document.getElementById('new-form-end').value = ''; loadFormsFromServer(); calendar.refetchEvents(); } });
        currentFormsContainer.addEventListener('click', async (e) => { if (e.target.classList.contains('delete-btn')) { const formId = e.target.getAttribute('data-id'); if (confirm('정말로 이 수업을 삭제하시겠습니까?')) { if (await handleAdminAction(`/api/forms/${formId}`, 'DELETE')) { loadFormsFromServer(); calendar.refetchEvents(); } } } });
        studentDetailsContainer.addEventListener('click', async (e) => {
            const submissionId = e.target.getAttribute('data-id');
            if (e.target.classList.contains('reprocess-btn')) { if (confirm(`ID ${submissionId}번 데이터를 '재처리 대기' 상태로 변경하시겠습니까?`)) { if (await handleAdminAction(`/api/reprocess/${submissionId}`, 'POST')) { e.target.textContent = '요청됨'; e.target.disabled = true; } } }
            if (e.target.classList.contains('edit-btn')) { if (confirm(`ID ${submissionId}번 데이터를 불러와 수정하시겠습니까?`)) { try { const response = await fetch(`/api/submission/${submissionId}`); const data = await response.json(); if (!response.ok) throw new Error(data.error || '데이터 로딩 실패'); populateFormForEdit(data); } catch (error) { alert(error.message); } } }
            if (e.target.classList.contains('delete-record-btn')) { if (confirm(`[주의!] ID ${submissionId}번 제출 기록을 영구적으로 삭제하시겠습니까?`)) { if (await handleAdminAction(`/api/submission/${submissionId}`, 'DELETE')) { e.target.closest('tr').remove(); calendar.refetchEvents(); } } }
        });
        document.getElementById('full-recalc-btn').addEventListener('click', async () => { const studentId = studentSelect.value; if (!studentId) { alert('먼저 학생을 선택해주세요.'); return; } if (confirm(`정말로 '${studentId}' 학생의 모든 데이터를 리셋하시겠습니까?`)) { if (await handleAdminAction('/api/full-recalculate', 'POST', { student_id: studentId })) { studentSelect.value = ''; } } });
        closeModal.onclick = () => { modal.style.display = "none"; }; window.onclick = (e) => { if (e.target == modal) { modal.style.display = "none"; } };
        formSelect.addEventListener('change', function() { const formId=this.value, mainContent=document.getElementById('main-content'), answersContainer=document.getElementById('answers-container'), subjectInput=document.getElementById('subject'); if (!formId) { mainContent.style.display='none'; return; } const selectedForm=forms.find(f => f.id === formId); if (selectedForm) { subjectInput.value=selectedForm.subject; answersContainer.innerHTML=''; for (let i=selectedForm.startNumber; i <= selectedForm.endNumber; i++) { const newRow=document.createElement('div'); newRow.className='answer-row'; newRow.innerHTML=`<input type="text" class="question_number" value="${i}" readonly><select class="is_correct"><option value="true">정답</option><option value="false">오답</option></select><input type="text" class="failed_edge_id" placeholder="오답일 경우, 틀린 부분 기술">`; answersContainer.appendChild(newRow); } mainContent.style.display='block'; } });
        document.getElementById('submission-form').addEventListener('submit', function(e) { e.preventDefault(); const formId=document.getElementById('form-select').value; if (!formId) { alert("먼저 수업을 선택해주세요."); return; } const studentData = { form_id: formId, student_name: document.getElementById('student_name').value, phone_suffix: document.getElementById('phone_suffix').value, subject: document.getElementById('subject').value, answers: [] }; document.querySelectorAll('.answer-row').forEach(r => { const qNum=r.querySelector('.question_number').value; if (qNum) { studentData.answers.push({ "Question Number": qNum, "is_correct": r.querySelector('.is_correct').value==='true', "failed_edge_id": r.querySelector('.failed_edge_id').value }); } }); fetch('/submit', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(studentData) }).then(res => res.json()).then(data => { const msgDiv=document.getElementById('message'); msgDiv.textContent=data.message; msgDiv.className='success'; msgDiv.style.display='block'; document.getElementById('main-content').style.display='none'; formSelect.value=''; this.reset(); setTimeout(() => msgDiv.style.display='none', 3000); if(calendar) calendar.refetchEvents(); }).catch(err => { const msgDiv=document.getElementById('message'); msgDiv.textContent='제출 오류'; msgDiv.className='error'; msgDiv.style.display='block'; console.error('Error:', err); }); });
        
        window.onload = loadFormsFromServer;
    </script>
</body>
</html>