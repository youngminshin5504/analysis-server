<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>학생 답안 제출 시스템</title>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js'></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 2em; background-color: #f4f4f9; color: #333; }
        .container { max-width: 80%; margin: auto; background-color: #fff; padding: 2em; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #0056b3; }
        .form-group { margin-bottom: 1.2em; }
        label { display: block; margin-bottom: 0.5em; font-weight: bold; }
        input, select { width: 100%; padding: 0.8em; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; }
        button { padding: 0.8em 1.5em; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; font-size: 1em; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        .delete-btn, .edit-btn, .delete-record-btn, .recalc-btn, .detail-btn { font-size: 0.8em; padding: 0.4em 0.8em; margin-left: 5px; }
        .delete-btn, .delete-record-btn { background-color: #dc3545; }
        .recalc-btn { background-color: #6f42c1;}
        .edit-btn { background-color: #17a2b8; }
        .detail-btn { background-color: #6c757d; }
        hr { border: 0; height: 1px; background-color: #eee; margin: 2em 0; }
        #message { margin-top: 1em; padding: 1em; border-radius: 5px; display: none; text-align: center; font-weight: bold; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        #admin-panel { display: none; border: 2px dashed #007bff; padding: 1.5em; border-radius: 8px; margin-top: 2em; }
        .form-list-item { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; padding: 0.5em; border-bottom: 1px solid #eee; }
        .admin-controls { text-align: right; margin-bottom: 1em; }
        .input-group { display: flex; gap: 10px; }
        .sub-panel { border: 1px solid #ddd; padding: 1em; margin-top: 1em; border-radius: 5px; }
        #answers-container .answer-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .answer-row input.question_number { flex: 0 0 70px; background-color: #e9ecef; text-align: center; }
        .answer-row select.is_correct { flex: 0 0 120px; }
        .answer-row input.failed_edge_id { flex: 1 1 auto; }
        #calendar { max-width: 1100px; margin: 2em auto; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 900px; border-radius: 8px; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        #student-details-container, #class-details-container { margin-top: 20px; max-height: 400px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        @media (max-width: 600px) {
            .container { width: 95%; padding: 1em; margin: 1em auto; }
            #answers-container .answer-row { flex-direction: column; align-items: stretch; border: 1px solid #eee; padding: 10px; border-radius: 5px; }
            .answer-row input.question_number, .answer-row select.is_correct { flex-basis: auto; width: 100%; }
            .input-group { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="admin-controls"><button id="toggle-admin-mode">관리자 모드</button></div>
        <div id="assistant-panel">
            <h1>학생 답안 제출</h1>
            <div class="form-group"><label for="form-select">수업 선택:</label><select id="form-select"><option value="">-- 먼저 수업을 선택하세요 --</option></select></div><hr>
            <div id="main-content" style="display: none;">
                <form id="submission-form">
                    <div class="form-group"><label for="student_name">학생 이름:</label><input type="text" id="student_name" required></div>
                    <div class="form-group"><label for="phone_suffix">전화번호 뒤 4자리:</label><input type="text" id="phone_suffix" pattern="\d{4}" required></div>
                    <div class="form-group"><label for="subject">과목 분류:</label><input type="text" id="subject" required readonly style="background-color: #e9ecef;"></div>
                    <h2>답안 입력</h2><div id="answers-container"></div><hr><button type="submit">제출하기</button>
                </form>
            </div>
        </div>
        <div id="admin-panel" style="display: none;">
            <h2>관리자 모드</h2>
            
            <div class="sub-panel">
                <h3>신규 수업 개설</h3>
                <div class="form-group">
                    <label for="reuse-form-select">최근 수업 설정 불러오기 (선택 사항):</label>
                    <select id="reuse-form-select"><option value="">-- 직접 입력 --</option></select>
                </div>
                <hr style="margin: 1em 0;">
                <div class="form-group"><label for="new-form-name">수업 이름:</label><input type="text" id="new-form-name" placeholder="예: 고3 미적분 심화"></div>
                <div class="form-group"><label for="new-form-subject">과목 분류:</label><input type="text" id="new-form-subject" placeholder="예: 미적분, 수1, 확통"></div>
                <div class="form-group"><label>문제 번호 범위:</label><div class="input-group"><input type="number" id="new-form-start" min="1" placeholder="시작"><input type="number" id="new-form-end" min="1" placeholder="끝"></div></div>
                <div class="form-group"><label>수업 활성화 기간 (해당 날짜에만 개설):</label><div class="input-group"><input type="date" id="new-form-start-date"><input type="date" id="new-form-end-date"></div></div>
                <button id="add-form-btn" style="margin-top: 1em;">수업 개설하기</button>
            </div>
            
            <div class="sub-panel">
                <h3>개설된 수업 목록</h3><div id="current-forms-container"></div>
            </div>

            <hr>
            <h2>제출 데이터 조회</h2><div id='calendar'></div><hr>
            
            <h2>학생 데이터 관리 (매우 주의!)</h2>
            <div class="sub-panel">
                <div class="form-group"><label for="student-select">관리할 학생 선택:</label><select id="student-select"><option value="">-- 학생을 선택하세요 --</option></select></div>
                <button id="delete-student-data-btn" class="delete-btn">선택 학생의 모든 프로필(.pkl) 영구 삭제</button>
            </div>
            
            <hr>
            <h2>전체 데이터 백업</h2>
            <button id="download-backup-btn">백업 파일 다운로드 시작</button>
        </div>
        <div id="message"></div>
    </div>
    <div id="detailsModal" class="modal"><div class="modal-content"><span class="close">&times;</span><h2 id="modalDateTitle"></h2><div id="student-details-container"></div></div></div>
    <div id="classDetailsModal" class="modal"><div class="modal-content"><span class="close">&times;</span><h2 id="classModalTitle"></h2><div id="class-details-container"></div></div></div>

    <script>
        const assistantPanel = document.getElementById('assistant-panel'), adminPanel = document.getElementById('admin-panel'), toggleAdminBtn = document.getElementById('toggle-admin-mode'), formSelect = document.getElementById('form-select'), studentSelect = document.getElementById('student-select'), reuseFormSelect = document.getElementById('reuse-form-select');
        let calendar = null; // [변경] calendar 변수를 null로 초기화
        let formsCache=[];
        const detailsModal = document.getElementById('detailsModal');
        const classDetailsModal = document.getElementById('classDetailsModal');
        const studentDetailsContainer = document.getElementById('student-details-container');
        const classDetailsContainer = document.getElementById('class-details-container');

        async function handleApiRequest(url, method, body) {
            try {
                const opts = { method, headers: {} };
                if (body) { opts.headers['Content-Type'] = 'application/json'; opts.body = JSON.stringify(body); }
                const res = await fetch(url, opts);
                if (res.status === 401) { 
                    // [변경] 401 에러 시 logout() 함수 호출
                    alert('인증이 만료되었거나 권한이 없습니다. 다시 로그인해주세요.'); 
                    logout(); 
                    return {success: false}; 
                }
                const result = await res.json();
                if (!res.ok) throw new Error(result.error || '작업 실패');
                return {success: true, data: result};
            } catch (error) { console.error(error); alert(error.message); return {success: false, error: error.message}; }
        }

        async function loadActiveFormsForAssistant() {
            const result = await handleApiRequest('/api/forms?active=true', 'GET');
            if(result.success) {
                formSelect.innerHTML = '<option value="">-- 수업 선택 --</option>';
                result.data.forEach(f => {
                    const o = document.createElement('option');
                    o.value = f.id; o.textContent = `${f.name} (${f.startDate})`;
                    o.dataset.subject = f.subject; o.dataset.startNumber = f.startNumber; o.dataset.endNumber = f.endNumber;
                    formSelect.appendChild(o);
                });
            }
        }
        
        async function loadAdminData() {
            loadAllFormsForAdmin();
            loadAllStudents();
        }

        async function loadAllFormsForAdmin() {
            const container = document.getElementById('current-forms-container');
            const result = await handleApiRequest('/api/forms', 'GET');
            if(result.success) {
                const groupedForms = result.data;
                formsCache = groupedForms;
                
                container.innerHTML = '';
                if(groupedForms.length === 0) { container.textContent = "현재 개설된 수업이 없습니다."; }
                else {
                    groupedForms.forEach(group => {
                        const item = document.createElement('div');
                        item.className = 'form-list-item';
                        item.innerHTML = `
                            <span><strong>${group.name}</strong> (${group.subject}) - ${group.instance_count}회 개설</span>
                            <div>
                                <button class="detail-btn" data-name="${group.name}">세부 보기</button>
                                <button class="delete-btn" data-name="${group.name}">전체 삭제</button>
                            </div>`;
                        container.appendChild(item);
                    });
                }
                
                reuseFormSelect.innerHTML = '<option value="">-- 직접 입력 --</option>';
                groupedForms.forEach(group => {
                    const opt = document.createElement('option');
                    opt.value = group.name;
                    opt.textContent = `${group.name} (${group.subject})`;
                    reuseFormSelect.appendChild(opt);
                });
            }
        }

        async function loadAllStudents() {
            const result = await handleApiRequest('/api/students', 'GET');
            if(result.success) {
                studentSelect.innerHTML = '<option value="">-- 학생 선택 --</option>';
                result.data.forEach(sId => { const o=document.createElement('option'); o.value=sId; o.textContent=sId; studentSelect.appendChild(o); });
            }
        }

        function renderStudentDetails(details, dateStr) {
            studentDetailsContainer.innerHTML = ''; 
            if (!details || details.length === 0) { studentDetailsContainer.textContent = '해당하는 데이터가 없습니다.'; return; }
            const table = document.createElement('table');
            table.innerHTML = `<thead><tr><th>ID</th><th>학생 식별</th><th>상태</th><th>최종 제출 시각</th><th style="width: 250px;">작업</th></tr></thead><tbody></tbody>`;
            const tbody = table.querySelector('tbody');
            details.forEach(item => {
                const row = tbody.insertRow();
                const studentIdentifier = `${item.student_name}(${item.phone_suffix})`;
                const statusText = item.status === 'processed' ? `완료` : '대기';
                row.innerHTML = `
                    <td>${item.id}</td>
                    <td>${studentIdentifier}</td>
                    <td>${statusText}</td>
                    <td>${new Date(item.submitted_at).toLocaleString('ko-KR')}</td>
                    <td>
                        <button class="recalc-btn" data-student-id="${item.student_id}" data-date="${dateStr}">재계산</button>
                        <button class="edit-btn" data-id="${item.id}">수정</button>
                        <button class="delete-record-btn" data-id="${item.id}">삭제</button>
                    </td>`;
            });
            studentDetailsContainer.appendChild(table);
        }
        
        function populateFormForEdit(data) {
            formSelect.value = data.form_id;
            formSelect.dispatchEvent(new Event('change'));
            document.getElementById('student_name').value = data.student_name;
            document.getElementById('phone_suffix').value = data.phone_suffix;
            setTimeout(() => {
                document.querySelectorAll('#answers-container .answer-row').forEach(row => {
                    const qNum = row.querySelector('.question_number').value;
                    const answerData = data.answers.find(ans => ans['Question Number'] === qNum);
                    if (answerData) {
                        row.querySelector('.is_correct').value = answerData.is_correct ? 'true' : 'false';
                        row.querySelector('.failed_edge_id').value = answerData.failed_edge_id || '';
                    }
                });
            }, 100);
            detailsModal.style.display = 'none';
            if (adminPanel.style.display === 'block') { toggleAdminBtn.click(); }
        }

        toggleAdminBtn.addEventListener('click', () => { (adminPanel.style.display === 'block') ? logout() : enterAdminMode(); });

        async function enterAdminMode() {
            const password = prompt("관리자 비밀번호를 입력하세요:");
            if (password) {
                const result = await handleApiRequest('/api/login', 'POST', {password});
                if(result.success){
                    adminPanel.style.display = 'block'; assistantPanel.style.display = 'none';
                    toggleAdminBtn.textContent = '로그아웃';
                    loadAdminData();

                    // [변경] 로그인 성공 시에만 달력 생성
                    if (!calendar) {
                        initializeCalendar();
                    }
                    calendar.render();
                } else { alert("비밀번호가 틀렸습니다."); }
            }
        }

        async function logout() {
            await handleApiRequest('/api/logout', 'POST');
            adminPanel.style.display = 'none'; assistantPanel.style.display = 'block';
            toggleAdminBtn.textContent = '관리자 모드';
            loadActiveFormsForAssistant();
            
            // [변경] 로그아웃 시 달력 인스턴스 파괴
            if (calendar) {
                calendar.destroy();
                calendar = null;
            }
        }

        // [변경] 페이지 로딩 시에는 달력을 초기화하지 않음
        document.addEventListener('DOMContentLoaded', function() {
            loadActiveFormsForAssistant();
        });
        
        // [신규] 달력 초기화 함수
        function initializeCalendar() {
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth', locale: 'ko',
                headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth' },
                events: async (fetchInfo, successCallback, failureCallback) => {
                    const result = await handleApiRequest(`/api/calendar/events?start=${fetchInfo.startStr}&end=${fetchInfo.endStr}`, 'GET');
                    if (result.success) {
                        successCallback(result.data);
                    } else {
                        // 에러 발생 시 빈 배열을 전달하여 TypeError 방지
                        console.error('달력 로딩 실패:', result.error);
                        failureCallback(new Error(result.error), []);
                    }
                },
                eventClick: async function(info) {
                    info.jsEvent.preventDefault();
                    const {formId, dateStr, formName} = {formId: info.event.extendedProps.formId, dateStr: info.event.startStr, formName: info.event.title};
                    document.getElementById('modalDateTitle').textContent = `${formName} (${dateStr}) 제출 목록`;
                    studentDetailsContainer.innerHTML = '<h4>로딩 중...</h4>'; detailsModal.style.display = "block";
                    const result = await handleApiRequest(`/api/data/by-date-form/${dateStr}/${formId}`, 'GET');
                    if (result.success) renderStudentDetails(result.data, dateStr);
                    else studentDetailsContainer.innerHTML = `<p style="color: red;">${result.error}</p>`;
                }
            });
        }

        reuseFormSelect.addEventListener('change', async function() {
            const selectedName = this.value;
            const group = formsCache.find(g => g.name === selectedName);
            const subjectInput = document.getElementById('new-form-subject');
            const nameInput = document.getElementById('new-form-name');
            if(group) {
                nameInput.value = group.name;
                subjectInput.value = group.subject;
                const result = await handleApiRequest(`/api/forms/by-name?name=${encodeURIComponent(selectedName)}`, 'GET');
                if(result.success && result.data.length > 0) {
                    const latestInstance = result.data[0];
                    document.getElementById('new-form-start').value = latestInstance.startNumber;
                    document.getElementById('new-form-end').value = latestInstance.endNumber;
                }
            } else {
                nameInput.value = ''; subjectInput.value = '';
                document.getElementById('new-form-start').value = ''; document.getElementById('new-form-end').value = '';
            }
        });

        document.getElementById('add-form-btn').addEventListener('click', async () => {
            const newForm = {
                id: `form_${Date.now()}`,
                name: document.getElementById('new-form-name').value.trim(),
                subject: document.getElementById('new-form-subject').value.trim(),
                startNumber: parseInt(document.getElementById('new-form-start').value),
                endNumber: parseInt(document.getElementById('new-form-end').value),
                startDate: document.getElementById('new-form-start-date').value,
                endDate: document.getElementById('new-form-end-date').value
            };
            if (!newForm.name || !newForm.subject || !newForm.startNumber || !newForm.endNumber || !newForm.startDate || !newForm.endDate) {
                alert('모든 항목을 올바르게 입력해주세요.'); return;
            }
            const result = await handleApiRequest('/api/forms', 'POST', newForm);
            if(result.success) {
                alert(result.data.message);
                document.getElementById('new-form-name').value = ''; document.getElementById('new-form-subject').value = '';
                document.getElementById('new-form-start').value = ''; document.getElementById('new-form-end').value = '';
                document.getElementById('new-form-start-date').value = ''; document.getElementById('new-form-end-date').value = '';
                reuseFormSelect.value = '';
                loadAllFormsForAdmin();
                if(calendar) calendar.refetchEvents();
            }
        });
        
        document.getElementById('current-forms-container').addEventListener('click', async (e) => {
            const button = e.target;
            const name = button.dataset.name;
            if (button.classList.contains('delete-btn')) {
                if(confirm(`'${name}' 수업 그룹 전체를 삭제하시겠습니까? 모든 날짜의 수업이 영구 삭제됩니다.`)) {
                    const result = await handleApiRequest('/api/forms/by-name', 'DELETE', { name });
                    if(result.success) { alert(result.data.message); loadAllFormsForAdmin(); if(calendar) calendar.refetchEvents(); }
                }
            } else if (button.classList.contains('detail-btn')) {
                document.getElementById('classModalTitle').textContent = `'${name}' 수업 상세 목록`;
                classDetailsContainer.innerHTML = '<h4>로딩 중...</h4>';
                classDetailsModal.style.display = 'block';
                const result = await handleApiRequest(`/api/forms/by-name?name=${encodeURIComponent(name)}`, 'GET');
                if(result.success) { renderClassInstances(result.data); }
            }
        });

        function renderClassInstances(instances) {
            classDetailsContainer.innerHTML = '';
            if (instances.length === 0) { classDetailsContainer.textContent = '해당 수업이 없습니다.'; return; }
            const table = document.createElement('table');
            table.innerHTML = `<thead><tr><th>활성화 기간</th><th>문제 범위</th><th>작업</th></tr></thead><tbody></tbody>`;
            const tbody = table.querySelector('tbody');
            instances.forEach(instance => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${instance.startDate} ~ ${instance.endDate}</td>
                    <td>${instance.startNumber} ~ ${instance.endNumber}</td>
                    <td><button class="delete-btn" data-id="${instance.id}">이 날짜만 삭제</button></td>`;
            });
            classDetailsContainer.appendChild(table);
        }

        classDetailsContainer.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-btn')) {
                const formId = e.target.dataset.id;
                if (confirm('이 날짜의 수업을 영구적으로 삭제하시겠습니까?')) {
                    const result = await handleApiRequest(`/api/forms/${formId}`, 'DELETE');
                    if(result.success) {
                        alert(result.data.message);
                        e.target.closest('tr').remove();
                        loadAllFormsForAdmin();
                        if(calendar) calendar.refetchEvents();
                    }
                }
            }
        });
        
        studentDetailsContainer.addEventListener('click', async (e) => {
            const button = e.target;
            const submissionId = button.dataset.id;
            if (button.classList.contains('recalc-btn')) {
                const studentId = button.dataset.studentId;
                const startDate = button.dataset.date;
                if(confirm(`'${studentId}' 학생의 ${startDate} 날짜부터의 모든 기록을 재계산하시겠습니까?`)) {
                    const result = await handleApiRequest('/api/recalculate-from-date', 'POST', { student_id: studentId, start_date: startDate });
                    if(result.success) { alert(result.data.message); detailsModal.style.display = 'none'; }
                }
            } else if (button.classList.contains('edit-btn')) {
                if(confirm(`ID ${submissionId}번 데이터를 불러와 수정할까요?`)) {
                    const result = await handleApiRequest(`/api/submission/${submissionId}`, 'GET');
                    if(result.success) populateFormForEdit(result.data);
                }
            } else if (button.classList.contains('delete-record-btn')) {
                if(confirm(`[주의!] ID ${submissionId}번 제출 기록을 영구적으로 삭제하시겠습니까?`)) {
                    const result = await handleApiRequest(`/api/submission/${submissionId}`, 'DELETE');
                    if(result.success) { alert(result.data.message); button.closest('tr').remove(); if(calendar) calendar.refetchEvents(); }
                }
            }
        });

        document.getElementById('delete-student-data-btn').addEventListener('click', async () => { /* 이전과 동일 */ });
        document.getElementById('download-backup-btn').addEventListener('click', () => { /* 이전과 동일 */ });
        formSelect.addEventListener('change', function() { /* 이전과 동일 */ });
        document.getElementById('submission-form').addEventListener('submit', async function(e) { /* 이전과 동일 */ });
        
        document.querySelectorAll('.modal .close').forEach(el => {
            el.onclick = () => { el.closest('.modal').style.display = "none"; }
        });
        window.onclick = (e) => { if (e.target.classList.contains('modal')) { e.target.style.display = "none"; } };
    </script>
</body>
</html>